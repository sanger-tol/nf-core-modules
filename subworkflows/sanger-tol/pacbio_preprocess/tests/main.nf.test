nextflow_workflow {

    name "Test Subworkflow PACBIO_PREPROCESS"
    script "../main.nf"
    workflow "PACBIO_PREPROCESS"
    config "./nextflow.config"

    tag "subworkflows"
    tag "subworkflows_sangertol"
    tag "subworkflows/pacbio_preprocess"
    tag "subworkflows/../../modules/nf-core/blast/blastn"
    tag "subworkflows/../../modules/nf-core/blast/makeblastdb"
    tag "subworkflows/../../modules/nf-core/hifitrimmer/processblast"
    tag "subworkflows/../../modules/nf-core/hifitrimmer/filterbam"
    tag "subworkflows/../../modules/nf-core/lima"
    tag "subworkflows/../../modules/nf-core/pbmarkdup"
    tag "subworkflows/../../modules/nf-core/samtools/fasta"
    tag "subworkflows/../../modules/nf-core/samtools/fastq"
    tag "subworkflows/../../modules/nf-core/samtools/import"
    tag "subworkflows/../../modules/nf-core/samtools/view"
    tag "subworkflows/../../modules/nf-core/seqkit/fq2fa"

    setup {
        nfcoreInitialise("${launchDir}/library/")
        nfcoreInstall(
            "${launchDir}/library/",
            [
                "blast/blastn",
                "blast/makeblastdb",
                "hifitrimmer/processblast",
                "hifitrimmer/filterbam",
                "lima",
                "pbmarkdup",
                "samtools/fasta",
                "samtools/fastq",
                "samtools/import",
                "samtools/view",
                "seqkit/fq2fa"
            ]
        )
        nfcoreLink("${launchDir}/library/", "${baseDir}/modules/")
    }

    test("acropora cervicornis") {

        when {
            params {
                lima_args             = "--hifi-preset SYMMETRIC-ADAPTERS"
                pbmarkdup_args        = "--clobber --rmdup --log-level INFO"
                samtools_fastq_args   = "-F 0x200 -nt"
                samtools_fasta_args   = ""
                fq2bam_args           = ""
                fq2cram_args          = "--output-fmt cram,version=3.0"
                fq2cram_untrim_args   = "--output-fmt cram,version=3.0"
                samtools_view_args    = "--output-fmt cram,version=3.0"
                makeblastdb_args      = "-dbtype nucl"
                blastn_args           = '-task blastn -reward 1 -penalty -5 -gapopen 3 -gapextend 3 -dust no -soft_masking true -evalue 700 -searchsp 1750000000000 -outfmt "6 std qlen"'
                hifitrimmer_args      = ""
            }

            workflow {
                """
                input[0] = Channel.of(
                    [
                        [ id:'test_bam' ],
                        file(params.modules_testdata_base_path + 'Acropora_cervicornis/genomic_data/m84093_241116_151316_s2.hifi_reads.bc2028.subset.bam', checkIfExists: true)
                    ],
                    [
                        [ id:'test_fasta' ],
                        file(params.modules_testdata_base_path + 'Acropora_cervicornis/genomic_data/m84093_241116_151316_s2.hifi_reads.bc2028.subset.fasta', checkIfExists: true)
                    ],
                    [
                        [ id:'test_fastq' ],
                        file(params.modules_testdata_base_path + 'Acropora_cervicornis/genomic_data/m84093_241116_151316_s2.hifi_reads.bc2028.subset.fastq', checkIfExists: true)
                    ]
                )
                input[1] = Channel.of(
                    [
                        [ id:'test_bam' ], // meta map
                        file(params.modules_testdata_base_path + 'resources/modules/pacbio_preprocess/HiFi_adapter.yaml', checkIfExists: true)
                    ],
                    [
                        [ id:'test_fasta' ], // meta map
                        file(params.modules_testdata_base_path + 'resources/modules/pacbio_preprocess/HiFi_adapter.yaml', checkIfExists: true)
                    ],
                    [
                        [ id:'test_fastq' ], // meta map
                        file(params.modules_testdata_base_path + 'resources/modules/pacbio_preprocess/HiFi_adapter.yaml', checkIfExists: true)
                    ]
                )
                input[2] = Channel.of(
                    [
                        [id:'blast_db'], // meta map
                        file(params.modules_testdata_base_path + 'resources/modules/pacbio_preprocess//HiFi_adapter_DB.fasta', checkIfExists: true)
                    ]
                )
                input[3] = file(params.modules_testdata_base_path + 'resources/modules/pacbio_preprocess/pacbio_uli_adapter.fasta', checkIfExists: true)
                input[4] = true
                input[5] = 'cram'
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.trimmed_cram.size() == 3 },
                { assert workflow.out.trimmed_fastx.size() == 3 }, // hifitrimmer always output fastx
                { assert workflow.out.untrimmed_cram.size() == 0 },
                { assert workflow.out.untrimmed_fastx.size() == 0 },
                {
                    assert snapshot(
                        workflow.out.untrimmed_fastx,
                        workflow.out.trimmed_fastx,
                        workflow.out.untrimmed_cram.collect{ meta, cram -> bam(cram).getStatistics() }.sort(),
                        workflow.out.trimmed_cram.collect{ meta, cram -> bam(cram).getStatistics() }.sort(),
                        workflow.out.hifitrimmer_summary.collect{ meta, summary_file ->
                            [ meta, path(summary_file).json.tap { it.remove('run_info') } ]
                        },
                        workflow.out.hifitrimmer_bed,
                        workflow.out.lima_report,
                        workflow.out.lima_summary,
                        workflow.out.pbmarkdup_stat,
                        workflow.out.versions
                    ).match()
                }
            )
        }

        cleanup {
            nfcoreUnlink("${launchDir}/library/", "${baseDir}/modules/nf-core")
        }
    }

    test("acropora cervicornis - non-uli - pbmarkdup - trim - cram") {

        when {
            params {
                lima_args             = "--hifi-preset SYMMETRIC-ADAPTERS"
                pbmarkdup_args        = "--clobber --rmdup --log-level INFO"
                samtools_fastq_args   = "-F 0x200 -nt"
                samtools_fasta_args   = ""
                fq2bam_args           = ""
                fq2cram_args          = "--output-fmt cram,version=3.0"
                fq2cram_untrim_args   = "--output-fmt cram,version=3.0"
                samtools_view_args    = "--output-fmt cram,version=3.0"
                makeblastdb_args      = "-dbtype nucl"
                blastn_args           = '-task blastn -reward 1 -penalty -5 -gapopen 3 -gapextend 3 -dust no -soft_masking true -evalue 700 -searchsp 1750000000000 -outfmt "6 std qlen"'
                hifitrimmer_args      = ""
            }

            workflow {
                """
                input[0] = channel.of(
                    [
                         [ id:'test_bam' ],
                        file(params.modules_testdata_base_path + 'Acropora_cervicornis/genomic_data/m84093_241116_151316_s2.hifi_reads.bc2028.subset.bam', checkIfExists: true)
                    ],
                    [
                        [ id:'test_fasta' ],
                        file(params.modules_testdata_base_path + 'Acropora_cervicornis/genomic_data/m84093_241116_151316_s2.hifi_reads.bc2028.subset.fasta', checkIfExists: true)
                    ],
                    [
                        [ id:'test_fastq' ],
                        file(params.modules_testdata_base_path + 'Acropora_cervicornis/genomic_data/m84093_241116_151316_s2.hifi_reads.bc2028.subset.fastq', checkIfExists: true)
                    ]
                )
                input[1] = channel.of(
                    [
                        [ id:'test_bam' ], // meta map
                        file(params.modules_testdata_base_path + 'resources/modules/pacbio_preprocess/HiFi_adapter.yaml', checkIfExists: true)
                    ],
                    [
                        [ id:'test_fastq' ], // meta map
                        file(params.modules_testdata_base_path + 'resources/modules/pacbio_preprocess/HiFi_adapter.yaml', checkIfExists: true)
                    ]
                )
                input[2] = channel.of(
                    [
                        [id:'blast_db'], // meta map
                        file(params.modules_testdata_base_path + 'resources/modules/pacbio_preprocess//HiFi_adapter_DB.fasta', checkIfExists: true)
                    ]
                )
                input[3] = []
                input[4] = true
                input[5] = 'cram'
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.trimmed_cram.size() == 2 },
                { assert workflow.out.trimmed_fastx.size() == 2 }, // hifitrimmer always output fastx
                { assert workflow.out.untrimmed_cram.size() == 1 },
                { assert workflow.out.untrimmed_fastx.size() == 0 },
                {
                    assert snapshot(
                        workflow.out.untrimmed_fastx,
                        workflow.out.trimmed_fastx,
                        workflow.out.untrimmed_cram.collect{ meta, cram -> bam(cram).getStatistics() }.sort(),
                        workflow.out.trimmed_cram.collect{ meta, cram -> bam(cram).getStatistics() }.sort(),
                        workflow.out.hifitrimmer_summary.collect{ meta, summary_file ->
                            [ meta, path(summary_file).json.tap { it.remove('run_info') } ]
                        },
                        workflow.out.hifitrimmer_bed,
                        workflow.out.lima_report,
                        workflow.out.lima_summary,
                        workflow.out.pbmarkdup_stat,
                        workflow.out.versions
                    ).match()
                }
            )
        }

        cleanup {
            nfcoreUnlink("${launchDir}/library/", "${baseDir}/modules/nf-core")
        }
    }

    test("acropora cervicornis - uli - no pbmarkdup - no trim - fastx") {

        when {
            params {
                lima_args             = "--hifi-preset SYMMETRIC-ADAPTERS"
                pbmarkdup_args        = "--clobber --rmdup --log-level INFO"
                samtools_fastq_args   = "-F 0x200 -nt"
                samtools_fasta_args   = ""
                fq2bam_args           = ""
                fq2cram_args          = "--output-fmt cram,version=3.0"
                fq2cram_untrim_args   = "--output-fmt cram,version=3.0"
                samtools_view_args    = "--output-fmt cram,version=3.0"
                makeblastdb_args      = "-dbtype nucl"
                blastn_args           = '-task blastn -reward 1 -penalty -5 -gapopen 3 -gapextend 3 -dust no -soft_masking true -evalue 700 -searchsp 1750000000000 -outfmt "6 std qlen"'
                hifitrimmer_args      = "-f"
            }

            workflow {
                """
                input[0] = channel.of(
                    [
                        [ id:'test_bam' ],
                        file(params.modules_testdata_base_path + 'Acropora_cervicornis/genomic_data/m84093_241116_151316_s2.hifi_reads.bc2028.subset.bam', checkIfExists: true)
                    ],
                    [
                        [ id:'test_fasta' ],
                        file(params.modules_testdata_base_path + 'Acropora_cervicornis/genomic_data/m84093_241116_151316_s2.hifi_reads.bc2028.subset.fasta', checkIfExists: true)
                    ],
                    [
                        [ id:'test_fastq' ],
                        file(params.modules_testdata_base_path + 'Acropora_cervicornis/genomic_data/m84093_241116_151316_s2.hifi_reads.bc2028.subset.fastq', checkIfExists: true)
                    ]
                )
                input[1] = channel.empty()
                input[2] = []
                input[3] = file(params.modules_testdata_base_path + 'resources/modules/pacbio_preprocess/pacbio_uli_adapter.fasta', checkIfExists: true)
                input[4] = false
                input[5] = ''
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.trimmed_cram.size() == 0 },
                { assert workflow.out.trimmed_fastx.size() == 0 }, // hifitrimmer always output fastx
                { assert workflow.out.untrimmed_cram.size() == 0 },
                { assert workflow.out.untrimmed_fastx.size() == 3 },
                {
                    assert snapshot(
                        workflow.out.untrimmed_fastx,
                        workflow.out.trimmed_fastx,
                        workflow.out.untrimmed_cram.collect{ meta, cram -> bam(cram).getStatistics() }.sort(),
                        workflow.out.trimmed_cram.collect{ meta, cram -> bam(cram).getStatistics() }.sort(),
                        workflow.out.hifitrimmer_summary.collect{ meta, summary_file ->
                            [ meta, path(summary_file).json.tap { it.remove('run_info') } ]
                        },
                        workflow.out.hifitrimmer_bed,
                        workflow.out.lima_report,
                        workflow.out.lima_summary,
                        workflow.out.pbmarkdup_stat,
                        workflow.out.versions
                    ).match()
                }
            )
        }

        cleanup {
            nfcoreUnlink("${launchDir}/library/", "${baseDir}/modules/nf-core")
        }
    }

    test("acropora cervicornis - uli - pbmarkdup - no trim - cram") {

        when {
            params {
                lima_args             = "--hifi-preset SYMMETRIC-ADAPTERS"
                pbmarkdup_args        = "--clobber --rmdup --log-level INFO"
                samtools_fastq_args   = "-F 0x200 -nt"
                samtools_fasta_args   = ""
                fq2bam_args           = ""
                fq2cram_args          = "--output-fmt cram,version=3.0"
                fq2cram_untrim_args   = "--output-fmt cram,version=3.0"
                samtools_view_args    = "--output-fmt cram,version=3.0"
                makeblastdb_args      = "-dbtype nucl"
                blastn_args           = '-task blastn -reward 1 -penalty -5 -gapopen 3 -gapextend 3 -dust no -soft_masking true -evalue 700 -searchsp 1750000000000 -outfmt "6 std qlen"'
                hifitrimmer_args      = "-f"
            }

            workflow {
                """
                input[0] = channel.of(
                    [
                        [ id:'test_bam' ],
                        file(params.modules_testdata_base_path + 'Acropora_cervicornis/genomic_data/m84093_241116_151316_s2.hifi_reads.bc2028.subset.bam', checkIfExists: true)
                    ],
                    [
                        [ id:'test_fasta' ],
                        file(params.modules_testdata_base_path + 'Acropora_cervicornis/genomic_data/m84093_241116_151316_s2.hifi_reads.bc2028.subset.fasta', checkIfExists: true)
                    ],
                    [
                        [ id:'test_fastq' ],
                        file(params.modules_testdata_base_path + 'Acropora_cervicornis/genomic_data/m84093_241116_151316_s2.hifi_reads.bc2028.subset.fastq', checkIfExists: true)
                    ]
                )
                input[1] = channel.empty()
                input[2] = []
                input[3] = file(params.modules_testdata_base_path + 'resources/modules/pacbio_preprocess/pacbio_uli_adapter.fasta', checkIfExists: true)
                input[4] = false
                input[5] = 'cram'
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.trimmed_cram.size() == 0 },
                { assert workflow.out.trimmed_fastx.size() == 0 }, // hifitrimmer always output fastx
                { assert workflow.out.untrimmed_cram.size() == 3 },
                { assert workflow.out.untrimmed_fastx.size() == 0 },
                {
                    assert snapshot(
                        workflow.out.untrimmed_fastx,
                        workflow.out.trimmed_fastx,
                        workflow.out.untrimmed_cram.collect{ meta, cram -> bam(cram).getStatistics() }.sort(),
                        workflow.out.trimmed_cram.collect{ meta, cram -> bam(cram).getStatistics() }.sort(),
                        workflow.out.hifitrimmer_summary.collect{ meta, summary_file ->
                            [ meta, path(summary_file).json.tap { it.remove('run_info') } ]
                        },
                        workflow.out.hifitrimmer_bed,
                        workflow.out.lima_report,
                        workflow.out.lima_summary,
                        workflow.out.pbmarkdup_stat,
                        workflow.out.versions
                    ).match()
                }
            )
        }

        cleanup {
            nfcoreUnlink("${launchDir}/library/", "${baseDir}/modules/nf-core")
        }
    }
}
